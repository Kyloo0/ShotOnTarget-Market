{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Shot On Target Market</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full min-h-screen pt-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <div class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Shot On Target Market</h1>
      <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500">ðŸ”¥ Your One-Stop Market, Always on Target! ðŸ”¥</p>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4 shadow-sm">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?filter=all" class="px-4 py-2 rounded-md text-sm font-medium transition-colors 
          {% if request.GET.filter != 'my' %} bg-red-600 text-white hover:bg-red-700 {% else %} bg-white text-gray-700 border hover:bg-gray-50 {% endif %}">
          All Products
        </a>
        <a href="?filter=my" class="px-4 py-2 rounded-md text-sm font-medium transition-colors 
          {% if request.GET.filter == 'my' %} bg-red-600 text-white hover:bg-red-700 {% else %} bg-white text-gray-700 border hover:bg-gray-50 {% endif %}">
          My Products
        </a>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500" id="last-login-display">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <div class="flex justify-between items-center mb-6">
      <button id="refresh-products" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition-colors">
        ðŸ”„ Refresh Products
      </button>
      {% if user.is_authenticated %}
        <button id="add-product-btn" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 transition-colors">
          Add Product
        </button>
      {% endif %}
    </div>

    <div id="loading" class="hidden col-span-full bg-white rounded-lg border p-12 text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
      <p class="mt-4 text-gray-600">Loading products...</p>
    </div>

    <div id="error" class="hidden col-span-full bg-red-50 border border-red-200 rounded-lg p-12 text-center">
      <p class="text-red-600">Failed to load products. Please try again.</p>
      <button id="retry-load" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Retry</button>
    </div>

    <div id="empty" class="hidden col-span-full bg-white rounded-lg border border-dashed p-12 text-center">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="mt-4 text-lg font-medium text-gray-900">No Products Found</h3>
      <p class="mt-1 text-sm text-gray-500 mb-6">It looks a bit empty here. Be the first to add a product!</p>
    </div>

    <div id="product-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    </div>

  </div>
</div>

{% include 'footer.html' %}
{% include 'modal.html' %}
{% include 'toast.html' %}

<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<script>
// ==================
// CONFIGURATION
// ==================
const PRODUCT_API_ENDPOINT = "{% url 'main:get_product_json' %}";
const ADD_PRODUCT_ENDPOINT = "/create-product-ajax/";
const CSRF_TOKEN = "{{ csrf_token }}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// ==================
// DOM ELEMENTS
// ==================
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const productGridContainer = document.getElementById('product-grid');
const showAllProductsButton = document.getElementById('filter-all');
const showMyProductsButton = document.getElementById('filter-my');
const refreshProductsButton = document.getElementById('refresh-products');
const addProductButton = document.getElementById('add-product-btn');
const retryLoadButton = document.getElementById('retry-load');

// ==================
// STATE VARIABLES
// ==================
let activeFilter = 'all';
let activeCategory = 'all';
let allProductsData = [];

// ==================
// UI FUNCTIONS
// ==================

// Update filter button appearance
function updateFilterButtonsAppearance() {
  if (!showAllProductsButton || !showMyProductsButton) return;
  
  const activeClasses = 'cursor-pointer bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors hover:bg-red-700';
  const inactiveClasses = 'cursor-pointer bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md text-sm font-medium transition-colors hover:bg-red-600 hover:text-white';

  if (activeFilter === 'all') {
    showAllProductsButton.className = activeClasses;
    showMyProductsButton.className = inactiveClasses;
  } else {
    showMyProductsButton.className = activeClasses;
    showAllProductsButton.className = inactiveClasses;
  }
}

// Show/hide page sections
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyStateDisplay.classList.toggle('hidden', !showEmpty);
  productGridContainer.classList.toggle('hidden', !showGrid);
  
  if (showGrid) {
    productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
  }
}

// Create product card element
function buildProductCardElement(item) {
    const card = document.createElement('article');
    card.className = "bg-white rounded-lg border border-gray-200 hover:shadow-xl transition-shadow duration-300 overflow-hidden";
    card.id = `product-${item.id}`;

    const name = DOMPurify.sanitize(item.name);
    const description = DOMPurify.sanitize(item.description);
    const price = new Intl.NumberFormat('id-ID').format(item.price);
    const category = DOMPurify.sanitize(item.get_category_display);
    const thumbnail = DOMPurify.sanitize(item.thumbnail || '');
    const userUsername = item.user_username;
    const isFeatured = item.is_featured;
    const isBestSeller = item.quantity_purchased >= 10;

    const thumbnailHtml = thumbnail
      ? `<img src="${thumbnail}" alt="${name}" class="w-full h-full object-cover">`
      : `<div class="w-full h-full bg-gray-200"></div>`;

    const categoryBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-red-600 text-white shadow">${item.category_display}</span>`;

    const featuredBadges = [];
    if (isFeatured) {
      featuredBadges.push(`<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>`);
    }
    if (isBestSeller) {
      featuredBadges.push(`<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">Best Seller</span>`);
    }
    const badgesHtml = featuredBadges.length > 0 ? `<div class="absolute top-3 right-3 flex space-x-2">${featuredBadges.join('')}</div>` : '';

    const isOwner = CURRENT_USER_ID && userUsername === "{{ user.username }}";

    const actionsHtml = isOwner
      ? `<div class="flex items-center justify-between pt-4 border-t border-gray-100">
          <a href="/show/${item.id}/" class="text-red-600 hover:text-red-700 font-medium text-sm transition-colors">View Details</a>
          <div class="flex space-x-3">
            <button onclick="showEditProductModal('${item.id}')" class="text-gray-600 hover:text-gray-900 font-medium text-sm transition-colors">Edit</button>
            <button onclick="showDeleteConfirmModal('${item.id}')" class="text-red-600 hover:text-red-800 font-medium text-sm transition-colors">Delete</button>
          </div>
        </div>`
      : `<div class="pt-4 border-t border-gray-100">
          <a href="/show/${item.id}/" class="text-red-600 hover:text-red-700 font-medium text-sm transition-colors">View Details â†’</a>
        </div>`;

    card.innerHTML = `
      <div class="aspect-[16/12] relative overflow-hidden bg-gray-100">
        ${thumbnailHtml}
        <div class="absolute top-3 left-3">
          ${categoryBadge}
        </div>
        ${badgesHtml}
      </div>
      <div class="px-12 py-24 flex-col flex-grow">
        <div class="flex items-center text-sm text-gray-500 mb-3">
          <span class="font-semibold text-lg text-red-600">Rp ${price}</span>
          <span class="mx-2">â€¢</span>
          <span>Stock: ${item.stock}</span>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
          <a href="/show/${item.id}/" class="hover:text-red-600 transition-colors">${name}</a>
        </h3>
        <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${description.split(' ').slice(0, 20).join(' ')}${description.split(' ').length > 20 ? '...' : ''}</p>
        ${actionsHtml}
      </div>
    `;
    return card;
}

// Render all product cards
function renderAllProductCards(products) {
  productGridContainer.innerHTML = '';
  products.forEach(product => {
    const cardElement = buildProductCardElement(product);
    productGridContainer.appendChild(cardElement);
  });
}

// ==================
// DATA & LOGIC
// ==================

// Fetch product data from server
async function fetchProductsFromServer() {
  try {
    displayPageSection({ showLoading: true });

    const params = new URLSearchParams();
    if (activeFilter === 'my') {
      params.append('filter', 'my');
    }
    if (activeCategory !== 'all') {
      params.append('category', activeCategory);
    }

    const response = await fetch(`${PRODUCT_API_ENDPOINT}?${params}`, {
      headers: { 'Accept': 'application/json' },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch product data from server');
    }

    const productData = await response.json();
    allProductsData = productData || [];

    if (allProductsData.length === 0) {
      displayPageSection({ showEmpty: true });
    } else {
      renderAllProductCards(allProductsData);
      displayPageSection({ showGrid: true });
    }
  } catch (error) {
    console.error('Error loading products:', error);
    displayPageSection({ showError: true });
  }
}

// Filter products by category
function filterProductsByCategory(category) {
  activeCategory = category;
  fetchProductsFromServer();
}

// Make function available globally for navbar
window.filterProductsByCategory = filterProductsByCategory;

// ==================
// EVENT HANDLERS
// ==================
function handleShowAllProductsClick() {
  activeFilter = 'all';
  activeCategory = 'all';
  updateFilterButtonsAppearance();
  fetchProductsFromServer();
}

function handleShowMyProductsClick() {
  activeFilter = 'my';
  activeCategory = 'all';
  updateFilterButtonsAppearance();
  fetchProductsFromServer();
}

function handleRefreshProductsClick() {
  fetchProductsFromServer();
}

function handleAddProductClick() {
  showCreateProductModal();
}

function handleRetryLoadClick() {
  fetchProductsFromServer();
}

// Initialize page
function initializeProductPage() {
  // Check URL parameters for initial state
  const urlParams = new URLSearchParams(window.location.search);
  const categoryParam = urlParams.get('category');
  const filterParam = urlParams.get('filter');

  if (categoryParam) {
    activeCategory = categoryParam;
  }
  if (filterParam) {
    activeFilter = filterParam;
  }

  if (showAllProductsButton) showAllProductsButton.addEventListener('click', handleShowAllProductsClick);
  if (showMyProductsButton) showMyProductsButton.addEventListener('click', handleShowMyProductsClick);
  if (refreshProductsButton) refreshProductsButton.addEventListener('click', handleRefreshProductsClick);
  if (addProductButton) addProductButton.addEventListener('click', handleAddProductClick);
  if (retryLoadButton) retryLoadButton.addEventListener('click', handleRetryLoadClick);

  updateFilterButtonsAppearance();
  fetchProductsFromServer();
}

// Start application
document.addEventListener('DOMContentLoaded', initializeProductPage);

// Custom event listener to refresh data (e.g., after adding/editing a product)
document.addEventListener('productsUpdated', function() {
    fetchProductsFromServer();
});

</script>
{% endblock content %}